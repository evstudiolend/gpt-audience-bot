from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from langchain.chat_models import ChatOpenAI
import uvicorn
import os

app = FastAPI()

# üîê CORS (–º–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –¥–æ–º–µ–Ω–æ–º Tilda)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

class InputData(BaseModel):
    question: str

# üîë –ö–ª—é—á OpenAI
openai_api_key = os.getenv("OPENAI_API_KEY")
if not openai_api_key:
    raise ValueError("OPENAI_API_KEY –Ω–µ –∑–∞–¥–∞–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")

# ü§ñ GPT-4o –º–æ–¥–µ–ª—å
llm = ChatOpenAI(model_name="gpt-4o", temperature=0.4, openai_api_key=openai_api_key)

# üî¢ –ü–æ–ª–Ω—ã–µ –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
steps = [
    """1. **–û–±—â–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏ –Ω–∏—à–∏**
- –£–¢–ü, –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ—Å—Ç—å, —Å–µ–≥–º–µ–Ω—Ç —Ä—ã–Ω–∫–∞""",

    """2. **–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –º–µ—Ç–æ–¥–∏–∫–µ 5W (–ú–∞—Ä–∫ –®–µ—Ä—Ä–∏–Ω–≥—Ç–æ–Ω):**
- Who ‚Äî –∫—Ç–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å (–≤–æ–∑—Ä–∞—Å—Ç, –ø–æ–ª, –¥–æ–ª–∂–Ω–æ—Å—Ç—å, –æ—Ç—Ä–∞—Å–ª—å, —Å—Ç–∏–ª—å –∂–∏–∑–Ω–∏)
- What ‚Äî —á—Ç–æ –º—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º (–æ–ø–∏—Å–∞–Ω–∏–µ, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è)
- Why ‚Äî –∑–∞—á–µ–º –ø–æ–∫—É–ø–∞—é—Ç (–º–æ—Ç–∏–≤–∞—Ü–∏—è, –±–æ–ª–∏, –∂–µ–ª–∞–Ω–∏—è)
- When ‚Äî –∫–æ–≥–¥–∞ –Ω—É–∂–µ–Ω –ø—Ä–æ–¥—É–∫—Ç
- Where ‚Äî –≥–¥–µ —ç—Ç—É –∞—É–¥–∏—Ç–æ—Ä–∏—é –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ (–æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω)""",

    """3. **–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏ (B2C –∏ B2B):**

üî∏ –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è:
- –†–µ–≥–∏–æ–Ω, –∫–ª–∏–º–∞—Ç, —á–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç—å, —Ç–∏–ø –Ω–∞—Å–µ–ª—ë–Ω–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞, —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

üî∏ –°–æ—Ü–∏–∞–ª—å–Ω–æ-–¥–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è:
- –ü–æ–ª, –≤–æ–∑—Ä–∞—Å—Ç, –¥–æ—Ö–æ–¥, –ø—Ä–æ—Ñ–µ—Å—Å–∏—è, —ç—Ç–∞–ø –∂–∏–∑–Ω–∏, –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, —Å–æ—Å—Ç–∞–≤ —Å–µ–º—å–∏

üî∏ –ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∞—è:
- –ü–æ–≤–æ–¥ –∫ –ø–æ–∫—É–ø–∫–µ, —á–∞—Å—Ç–æ—Ç–∞, –º–æ—Ç–∏–≤–∞—Ü–∏—è, —ç—Ç–∞–ø –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø—É—Ç–∏, –º–µ—Å—Ç–æ –ø–æ–∫—É–ø–∫–∏

üî∏ –ü—Å–∏—Ö–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è:
- –¶–µ–Ω–Ω–æ—Å—Ç–∏, —Å—Ç–∏–ª—å –∂–∏–∑–Ω–∏, —Ç–∏–ø –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è, –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –Ω–æ–≤–∏–∑–Ω–µ

üî∏ B2B (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ):
- –û—Ç—Ä–∞—Å–ª—å, –æ–±—ä—ë–º –∑–∞–∫—É–ø–æ–∫, —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–∫—É–ø–∫–∏, —Ä–æ–ª–∏ –≤ –∫–æ–º–∏—Ç–µ—Ç–µ""",

    """4. **–ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã:**
- –ë–æ–ª–∏ –∏ –ø—Ä–æ–±–ª–µ–º—ã
- –°–æ–º–Ω–µ–Ω–∏—è, —Å—Ç—Ä–∞—Ö–∏, –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
- –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏ –ø—Ä–æ–¥–∞–≤—Ü–∞
- –û–∂–∏–¥–∞–Ω–∏—è –∏ –∫–∞–∫ –∏—Ö –ø—Ä–µ–≤–∑–æ–π—Ç–∏
- –ö—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ, —Å –∫–µ–º —Å–æ–≤–µ—Ç—É—é—Ç—Å—è""",

    """5. **–ü—É—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ (Customer Journey):**
- –≠—Ç–∞–ø—ã –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è
- –ß—Ç–æ –≤–∞–∂–Ω–æ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ""",

    """6. **Jobs To Be Done:**
- –ß—Ç–æ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç '–Ω–∞–Ω—è—Ç—å' –ø—Ä–æ–¥—É–∫—Ç —Å–¥–µ–ª–∞—Ç—å
- –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç: ¬´–ö–æ–≥–¥–∞ —è..., —è —Ö–æ—á—É..., —á—Ç–æ–±—ã...¬ª""",

    """7. **–¢–∏–ø–æ–≤—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏:**
- –ò–º—è, –≤–æ–∑—Ä–∞—Å—Ç, –ø—Ä–æ—Ñ–µ—Å—Å–∏—è, —Å—Ç–∏–ª—å –∂–∏–∑–Ω–∏, –º–æ—Ç–∏–≤–∞—Ü–∏—è, —Å—Ç—Ä–∞—Ö–∏, –∫–∞–∫ –ø–æ–∫—É–ø–∞–µ—Ç""",

    """8. **–ö–∞–Ω–∞–ª—ã –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –ì–¥–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª–∏ –¶–ê –æ–±—ã—á–Ω–æ –∏—â—É—Ç —Ä–µ—à–µ–Ω–∏–µ —Å–≤–æ–µ–π –∑–∞–¥–∞—á–∏ –≤ —Ä–∞–º–∫–∞—Ö –¥–∞–Ω–Ω–æ–π –Ω–∏—à–∏: –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω-–∫–∞–Ω–∞–ª—ã (—Å–æ—Ü—Å–µ—Ç–∏, —Å–∞–π—Ç—ã, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏, –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏ –ø—Ä.)
- –ö–∞–∫ –æ–Ω–∏ –ø—Ä–∏–Ω–∏–º–∞—é—Ç —Ä–µ—à–µ–Ω–∏–µ, —É –∫–æ–≥–æ –∫—É–ø–∏—Ç—å: —á—Ç–æ –¥–ª—è –Ω–∏—Ö –≤–∞–∂–Ω–æ (–¥–æ–≤–µ—Ä–∏–µ, —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ—Å—Ç—å, –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å, –æ—Ç–∑—ã–≤—ã, –ª–∏—á–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ —Ç.–¥.)
- –ù–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π—Å—è —à–∞–±–ª–æ–Ω–æ–º ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¶–ê –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –Ω–∏—à–∏ –ø—Ä–æ–¥—É–∫—Ç–∞""",

    """9. **–í—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –ö–æ–º—É –ø—Ä–æ–¥–∞–≤–∞—Ç—å –∏ —á–µ—Ä–µ–∑ —á—Ç–æ
- –ö–∞–∫ –≤—ã–¥–µ–ª–∏—Ç—å—Å—è, –∫–∞–∫ –≥–æ–≤–æ—Ä–∏—Ç—å
- –ö–∞–∫ –æ–±–æ–π—Ç–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤"""
]

# üö™ –≠–Ω–¥–ø–æ–∏–Ω—Ç
@app.post("/analyze")
async def analyze(data: InputData):
    description = data.question
    all_steps_output = "‚è≥ GPT –Ω–∞—á–∞–ª –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑..."

    for i, step in enumerate(steps):
        step_prompt = f"""–¢—ã ‚Äî –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –∏ –±—Ä–µ–Ω–¥-—Å—Ç—Ä–∞—Ç–µ–≥.

üåü –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ –≤—ã–¥–∞—Ç—å —à–∞–±–ª–æ–Ω, –∞ ‚Äî –ø–æ–Ω—è—Ç—å —Å—É—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞ –∏ –ø–æ–º–æ—á—å –∞–≤—Ç–æ—Ä—É –≤–∑–≥–ª—è–Ω—É—Ç—å –Ω–∞ –Ω–µ–≥–æ –≥–ª–∞–∑–∞–º–∏ –∫–ª–∏–µ–Ω—Ç–∞.

üß† –ü–∏—à–∏, –∫–∞–∫ –æ–ø—ã—Ç–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç: –∂–∏–≤—ã–º, –ø–æ–Ω—è—Ç–Ω—ã–º —è–∑—ã–∫–æ–º, —É–≤–µ—Ä–µ–Ω–Ω–æ. –î–µ–ª–∞–π –≤—ã–≤–æ–¥—ã. –ù–µ –±–æ–π—Å—è "–∑–∞–π—Ç–∏ –¥–∞–ª—å—à–µ", –µ—Å–ª–∏ –≤–∏–¥–∏—à—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –∏–Ω—Å–∞–π—Ç.

–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞:
{description}

üìå –§–æ—Ä–º–∞—Ç:
- –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ø–∏—Å–∫–∏, —Ç–∞–±–ª–∏—Ü—ã
- –î–µ–ª–∞–π —è—Å–Ω—ã–µ –≤—ã–≤–æ–¥—ã
- –ò–∑–±–µ–≥–∞–π —Å—É—Ö–æ—Å—Ç–∏ –∏ –∞–∫–∞–¥–µ–º–∏—á–Ω–æ—Å—Ç–∏
- –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—ã –ø–∏—à–µ—à—å —ç—Ç–æ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –æ–Ω –º–æ–≥ —Ä–µ–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è

üö´ –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –¥–∞–Ω–Ω—ã–µ ‚Äî —Å—Ç—Ä–æ–π –≤—ã–≤–æ–¥—ã –ª–æ–≥–∏—á–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞.

### –®–∞–≥ {i + 1}:
{step}
"""
        response = llm.predict(step_prompt)
        all_steps_output += f"\n\n‚ñ∂Ô∏è –®–∞–≥ {i + 1}:\n{response}"

    all_steps_output += "\n\n‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω."
    return {"answer": all_steps_output}

# üöÄ –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫
if __name__ == "__main__":
    import os
    port = int(os.environ.get("PORT", 8000))
    uvicorn.run(app, host="0.0.0.0", port=port)

